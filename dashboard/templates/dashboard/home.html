{% extends 'registration/base.html' %}
{% load static %}

{% block title %}Dashboard â€” Vetri Finance{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto py-12">

  <!-- SUMMARY CARDS -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
    <div class="p-6 rounded-2xl bg-gradient-to-br from-green-100 via-white to-green-50 shadow-lg text-center transform hover:-translate-y-1 transition-all">
      <h3 class="text-lg font-semibold text-gray-700">Total Income</h3>
      <p id="totalIncome" class="text-4xl font-extrabold text-green-600 mt-2">â‚¹0</p>
    </div>
    <div class="p-6 rounded-2xl bg-gradient-to-br from-red-100 via-white to-red-50 shadow-lg text-center transform hover:-translate-y-1 transition-all">
      <h3 class="text-lg font-semibold text-gray-700">Total Expenses</h3>
      <p id="totalExpense" class="text-4xl font-extrabold text-red-600 mt-2">â‚¹0</p>
    </div>
    <div class="p-6 rounded-2xl bg-gradient-to-br from-indigo-100 via-white to-indigo-50 shadow-lg text-center transform hover:-translate-y-1 transition-all">
      <h3 class="text-lg font-semibold text-gray-700">Net Balance</h3>
      <p id="netBalance" class="text-4xl font-extrabold text-indigo-700 mt-2">â‚¹0</p>
    </div>
  </div>

  <!-- FILTER FORM -->
  <div class="bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-md mb-12 border border-gray-200">
    <form method="get" action="" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Transaction Type</label>
        <select name="type" class="w-full border-gray-300 rounded-xl py-2 px-3" onchange="this.form.submit()">
          <option value="">All Types</option>
          <option value="income" {% if selected_type == 'income' %}selected{% endif %}>Income</option>
          <option value="expense" {% if selected_type == 'expense' %}selected{% endif %}>Expense</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Start Date</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="w-full border-gray-300 rounded-xl py-2 px-3">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">End Date</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="w-full border-gray-300 rounded-xl py-2 px-3">
      </div>

      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-xl hover:shadow-lg transition">
          ğŸ” Filter
        </button>
        <button type="reset" onclick="window.location.href=''" 
                class="bg-gray-100 px-3 py-2 rounded-xl hover:bg-gray-200">
          ğŸ§¹
        </button>
      </div>
    </form>
  </div>

  <!-- CHARTS -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
    <div class="p-6 rounded-2xl bg-white/90 backdrop-blur-lg shadow-md border border-gray-200 text-center">
      <h3 class="text-xl font-bold text-purple-700 mb-4">Income vs Expense</h3>
      <canvas id="pieChart" class="mx-auto" aria-label="Pie chart showing income and expenses" role="img"></canvas>
    </div>

    <div class="p-6 rounded-2xl bg-white/90 backdrop-blur-lg shadow-md border border-gray-200 text-center">
      <h3 class="text-xl font-bold text-indigo-700 mb-4">Weekly Income vs Expense</h3>
      <canvas id="barChart" class="mx-auto" aria-label="Bar chart of weekly income and expense" role="img"></canvas>
    </div>

    <div class="p-6 rounded-2xl bg-white/90 backdrop-blur-lg shadow-md border border-gray-200 text-center">
      <h3 class="text-xl font-bold text-green-700 mb-4">Financial Health Gauge</h3>
      <canvas id="gaugeChart" class="mx-auto" aria-label="Gauge chart showing savings ratio" role="img"></canvas>
      <p class="mt-4 text-gray-600 text-sm italic">Shows how much of your income youâ€™ve saved ğŸ’¡</p>
    </div>
  </div>

  <!-- DOWNLOAD PDF BUTTON -->
  <div class="text-center mb-16">
    <a href="{% url 'download_report' %}" 
       class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold hover:shadow-lg hover:scale-105 transition-all duration-300">
      ğŸ“„ Download Financial Report (PDF)
    </a>
    <p class="text-xs text-gray-500 mt-2">Get a summary of your income, expenses, and insights.</p>
  </div>

  <!-- RECENT TRANSACTIONS -->
  <div class="bg-white/90 backdrop-blur-lg p-8 rounded-2xl shadow-md border border-gray-200 overflow-x-auto">
    <h3 class="text-2xl font-bold text-center text-purple-800 mb-6">ğŸ“œ Recent Transactions</h3>
    <table class="table-auto w-full text-sm">
      <thead class="border-b border-gray-300 bg-gray-50">
        <tr>
          <th scope="col" class="py-3 px-4 text-left">Title</th>
          <th scope="col" class="py-3 px-4">Amount</th>
          <th scope="col" class="py-3 px-4">Type</th>
          <th scope="col" class="py-3 px-4">Date</th>
        </tr>
      </thead>
      <tbody>
        {% for t in recent_transactions %}
        <tr class="border-b border-gray-200 hover:bg-gray-100 transition">
          <td class="py-3 px-4 text-left">{{ t.title }}</td>
          <td class="py-3 px-4 font-semibold {% if t.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
            â‚¹{{ t.amount }}
          </td>
          <td class="py-3 px-4 capitalize">{{ t.type }}</td>
          <td class="py-3 px-4">{{ t.date }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center py-4 text-gray-500">No recent transactions</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let pieChart, barChart, gaugeChart;

  // Fetch and render data
  function updateCharts() {
    fetch("{% url 'dashboard_summary' %}?period=month")
      .then(res => res.json())
      .then(data => {
        const { income, expense, balance, weekly_income, weekly_expense, week_labels } = data;
        const savingsRatio = income > 0 ? ((income - expense) / income * 100).toFixed(1) : 0;

        // âœ… Directly display values (no animation)
        document.getElementById('totalIncome').innerText = `â‚¹${Math.round(income).toLocaleString()}`;
        document.getElementById('totalExpense').innerText = `â‚¹${Math.round(expense).toLocaleString()}`;
        document.getElementById('netBalance').innerText = `â‚¹${Math.round(balance).toLocaleString()}`;

        // PIE CHART
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'doughnut',
          data: {
            labels: ['Income', 'Expense'],
            datasets: [{
              data: [income, expense],
              backgroundColor: ['#10b981', '#ef4444'],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            plugins: { legend: { position: 'bottom' } },
            cutout: '70%'
          }
        });

        // WEEKLY BAR CHART
        if (barChart) barChart.destroy();
        barChart = new Chart(document.getElementById('barChart'), {
          type: 'bar',
          data: {
            labels: week_labels,
            datasets: [
              {
                label: 'Income (â‚¹)',
                data: weekly_income,
                backgroundColor: '#10b981',
                borderRadius: 6
              },
              {
                label: 'Expense (â‚¹)',
                data: weekly_expense,
                backgroundColor: '#ef4444',
                borderRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
              x: { grid: { display: false } }
            },
            plugins: { legend: { position: 'bottom' } },
            animation: { duration: 1000, easing: 'easeOutQuart' }
          }
        });

        // GAUGE CHART
        if (gaugeChart) gaugeChart.destroy();
        gaugeChart = new Chart(document.getElementById('gaugeChart'), {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [savingsRatio, 100 - savingsRatio],
              backgroundColor: ['#22c55e', '#e5e7eb'],
              borderWidth: 0,
              circumference: 180,
              rotation: 270,
              cutout: '70%'
            }]
          },
          options: { plugins: { legend: { display: false } } },
          plugins: [{
            id: 'centerText',
            beforeDraw(chart) {
              const { width, chartArea: { top, bottom }, ctx } = chart;
              ctx.save();
              ctx.font = 'bold 22px Poppins';
              ctx.textAlign = 'center';
              ctx.fillStyle = '#15803d';
              ctx.fillText(`${savingsRatio}%`, width / 2, (top + bottom) / 1.5);
            }
          }]
        });
      })
      .catch(err => console.error("Chart data load failed:", err));
  }

  updateCharts();
});
</script>

{% endblock %}
